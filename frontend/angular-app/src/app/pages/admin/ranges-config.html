<div class="ranges-config">
  <header class="page-header">
    <div class="titles">
      <h1>{{ titulo }}</h1>
      <div class="subtitle" *ngIf="subtitulo">{{ subtitulo }}</div>
    </div>
    <div class="actions">
      <button class="btn ghost" (click)="volverArriba()" [disabled]="vista === 'muebles'">
        Volver
      </button>
    </div>
  </header>

  <nav class="boxes">
    <button class="box" [class.active]="vista === 'muebles'" (click)="vista = 'muebles'">Muebles</button>
    <button
      class="box"
      [class.active]="vista === 'estantes'"
      (click)="seleccionado.mueble ? (vista = 'estantes') : null"
      [disabled]="!seleccionado.mueble"
    >
      Estantes
    </button>
    <button
      class="box"
      [class.active]="vista === 'anaqueles'"
      (click)="seleccionado.estante ? (vista = 'anaqueles') : null"
      [disabled]="!seleccionado.estante"
    >
      Anaqueles
    </button>
  </nav>

  <div class="loading" *ngIf="cargando">Cargando estructura...</div>
  <div class="alert" *ngIf="!cargando && error">{{ error }}</div>

  <ng-container *ngIf="!cargando && !error">
    <!-- Mensajes de guardado -->
    <div *ngIf="saveMessage" class="alert" [class.success]="saveMessageType === 'success'" [class.error]="saveMessageType === 'error'">
      {{ saveMessage }}
    </div>
    <!-- Muebles -->
    <section class="panel" [class.hidden]="vista !== 'muebles'">
      <h2>Muebles</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Código inicial</th>
            <th>Código final</th>
            <th>Estado</th>
            <th>Última actualización</th>
            <th>Acciones</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of data" [class.selected]="seleccionado.mueble === m">
            <td><input type="number" [(ngModel)]="m.numero" [disabled]="!isEditing('module', m.id)" placeholder="Ej. 1" /></td>
            <td><input [(ngModel)]="m.rango.inicio" [disabled]="!isEditing('module', m.id)" placeholder="Ej. A100" /></td>
            <td><input [(ngModel)]="m.rango.fin" [disabled]="!isEditing('module', m.id)" placeholder="Ej. A199" /></td>
            <td>
              <select [(ngModel)]="m.rango.estado" [disabled]="!isEditing('module', m.id)">
                <option>Activo</option>
                <option>Inactivo</option>
              </select>
            </td>
            <td>{{ m.rango.actualizado || 'Sin actualizar' }}</td>
            <td class="actions">
              <button class="btn view" (click)="seleccionarMueble(m)">Ver estantes</button>
              <ng-container *ngIf="!isEditing('module', m.id); else moduleSave">
                <button class="btn edit" (click)="startEditModule(m)">Editar</button>
              </ng-container>
              <ng-template #moduleSave>
                <button class="btn save" (click)="saveModuleRow(m)">Guardar</button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Estantes -->
    <section class="panel" *ngIf="seleccionado.mueble as mueble" [class.hidden]="vista !== 'estantes'">
      <h2>Estantes de {{ mueble.nombre }}</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Orientación</th>
            <th>Código inicial</th>
            <th>Código final</th>
            <th>Estado</th>
            <th>Última actualización</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let e of mueble.estantes" [class.selected]="seleccionado.estante === e">
            <td><input type="number" [(ngModel)]="e.numero" [disabled]="!isEditing('shelving-unit', e.id)" placeholder="Ej. 1" /></td>
            <td>{{ e.orientacion }}</td>
            <td><input [(ngModel)]="e.rango.inicio" [disabled]="!isEditing('shelving-unit', e.id)" /></td>
            <td><input [(ngModel)]="e.rango.fin" [disabled]="!isEditing('shelving-unit', e.id)" /></td>
            <td>
              <ng-container *ngIf="!isEditing('shelving-unit', e.id); else unitEditEstado">
                <select [(ngModel)]="e.rango.estado" (ngModelChange)="onShelvingUnitEstadoChange(e, $event)">
                  <option>Activo</option>
                  <option>Inactivo</option>
                </select>
              </ng-container>
              <ng-template #unitEditEstado>
                <select [(ngModel)]="e.rango.estado">
                  <option>Activo</option>
                  <option>Inactivo</option>
                </select>
              </ng-template>
            </td>
            <td>{{ e.rango.actualizado || 'Sin actualizar' }}</td>
            <td class="actions">
              <button class="btn view" (click)="seleccionarEstante(e)">Ver anaqueles</button>
              <ng-container *ngIf="!isEditing('shelving-unit', e.id); else unitSave">
                <button class="btn edit" (click)="startEditUnit(e)">Editar</button>
              </ng-container>
              <ng-template #unitSave>
                <button class="btn save" (click)="saveUnitRow(e)">Guardar</button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Anaqueles -->
    <section class="panel" *ngIf="seleccionado.estante as estante" [class.hidden]="vista !== 'anaqueles'">
      <h2>Anaqueles de {{ estante.nombre }}</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Código inicial</th>
            <th>Código final</th>
            <th>Estado</th>
            <th>Última actualización</th>
            <th>Acciones</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of estante.anaqueles">
            <td><input type="number" [(ngModel)]="a.numero" [disabled]="!isEditing('shelf', a.id)" placeholder="Ej. 1" /></td>
            <td><input [(ngModel)]="a.rango.inicio" [disabled]="!isEditing('shelf', a.id)" /></td>
            <td><input [(ngModel)]="a.rango.fin" [disabled]="!isEditing('shelf', a.id)" /></td>
            <td>
              <ng-container *ngIf="!isEditing('shelf', a.id); else shelfEditEstado">
                <select [(ngModel)]="a.rango.estado" (ngModelChange)="onShelfEstadoChange(a, $event)">
                  <option>Activo</option>
                  <option>Inactivo</option>
                </select>
              </ng-container>
              <ng-template #shelfEditEstado>
                <select [(ngModel)]="a.rango.estado">
                  <option>Activo</option>
                  <option>Inactivo</option>
                </select>
              </ng-template>
            </td>
            <td>{{ a.rango.actualizado || 'Sin actualizar' }}</td>
            <td class="actions">
              <ng-container *ngIf="!isEditing('shelf', a.id); else shelfSave">
                <button class="btn edit" (click)="startEditShelf(a)">Editar</button>
              </ng-container>
              <ng-template #shelfSave>
                <button class="btn save" (click)="saveShelfRow(a)">Guardar</button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </section>
  </ng-container>
</div>

<!-- Modal de edición -->
<app-edit-modal
  [isOpen]="isEditModalOpen"
  [item]="editingItem"
  (closed)="onEditModalClosed()"
  (saved)="onEditModalSaved()">
</app-edit-modal>
