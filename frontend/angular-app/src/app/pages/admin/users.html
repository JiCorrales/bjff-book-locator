<div class="users-page">
  <header class="page-header">
    <div>
      <h1>Usuarios</h1>
      <p class="subtitle">Administra cuentas de bibliotecarios y asistentes.</p>
    </div>
    <div class="metric">
      <span class="value" aria-live="polite">{{ totalUsers }}</span>
      <span class="label">Personas</span>
    </div>
  </header>

  <section class="form-section" [attr.aria-busy]="isSubmitting">
    <h2>{{ mode === 'create' ? 'Crear usuario' : 'Editar usuario' }}</h2>
    <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
      <div class="grid">
        <label>
          <span>Nombre</span>
          <input type="text" formControlName="firstName" autocomplete="given-name" />
          <small *ngIf="getError('firstName')" class="error">{{ getError('firstName') }}</small>
        </label>
        <label>
          <span>Apellido</span>
          <input type="text" formControlName="lastName" autocomplete="family-name" />
          <small *ngIf="getError('lastName')" class="error">{{ getError('lastName') }}</small>
        </label>
        <label>
          <span>Correo electr�nico</span>
          <input type="email" formControlName="email" autocomplete="email" />
          <small *ngIf="getError('email')" class="error">{{ getError('email') }}</small>
        </label>
        <label>
          <span>Rol</span>
          <select formControlName="role">
            <option *ngFor="let r of roleOptions" [value]="r">
              {{ r === 'admin' ? 'Administrador' : 'Asistente' }}
            </option>
          </select>
        </label>
        <label>
          <span>Estado</span>
          <select formControlName="isActive">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </label>
        <label *ngIf="form.get('role')?.value === 'assistant'">
          <span>Tec ID</span>
          <input type="text" formControlName="tecId" placeholder="TEC000001" />
          <small *ngIf="getError('tecId')" class="error">{{ getError('tecId') }}</small>
        </label>
      </div>

      <div class="grid">
        <label>
          <span>{{ mode === 'create' ? 'Contraseña' : 'Nueva contraseña' }}</span>
          <input type="password" formControlName="password" autocomplete="new-password" />
          <small *ngIf="getError('password')" class="error">{{ getError('password') }}</small>
        </label>
        <label>
          <span>Confirmar contraseña</span>
          <input type="password" formControlName="confirmPassword" autocomplete="new-password" />
          <small *ngIf="getError('confirmPassword')" class="error">{{ getError('confirmPassword') }}</small>
        </label>
      </div>

      <div class="form-actions">
        <button class="btn primary" type="submit" [disabled]="form.invalid || isSubmitting">
          {{ mode === 'create' ? 'Crear' : 'Guardar cambios' }}
        </button>
        <button
          type="button"
          class="btn ghost"
          *ngIf="mode === 'edit'"
          (click)="cancelEdit()"
          [disabled]="isSubmitting"
        >
          Cancelar edici�n
        </button>
      </div>
      <p class="helper">
        Las contraseñas deben tener al menos 8 caracteres. Para asistentes, ingresa un Tec ID válido.
      </p>
    </form>
  </section>

  <section class="list-section">
    <div class="list-controls">
      <input
        type="search"
        class="search"
        placeholder="Buscar por nombre o correo"
        [formControl]="searchControl"
      />
      <select [(ngModel)]="statusFilter" aria-label="Filtrar por estado">
        <option value="all">Todos</option>
        <option value="active">Activos</option>
        <option value="inactive">Inactivos</option>
      </select>
    </div>

    <div class="error banner" *ngIf="loadError">{{ loadError }}</div>

    <table class="table" aria-live="polite">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Correo</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Última actualización</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers" [class.editing]="selectedUser?.id === user.id">
          <td>
            <div class="name">{{ user.fullName }}</div>
            <div class="tec" *ngIf="user.tecId">Tec ID: {{ user.tecId }}</div>
          </td>
          <td>{{ user.email }}</td>
          <td>{{ user.role }}</td>
          <td>
            <span class="badge" [class.active]="user.isActive" [class.inactive]="!user.isActive">
              {{ user.isActive ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>{{ user.updatedAt | date: 'medium' }}</td>
          <td class="actions">
            <button class="link" (click)="edit(user)">Editar</button>
            <button class="link danger" (click)="delete(user)">Eliminar</button>
          </td>
        </tr>
        <tr *ngIf="!isLoading && !filteredUsers.length">
          <td colspan="6" class="empty">No hay usuarios que coincidan con la búsqueda.</td>
        </tr>
        <tr *ngIf="isLoading">
          <td colspan="6" class="empty">Cargando usuarios…</td>
        </tr>
      </tbody>
    </table>
  </section>
</div>